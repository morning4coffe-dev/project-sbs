<Page x:Class="ProjectSBS.Presentation.Components.ItemDetails"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:ProjectSBS.Presentation.Components"
      xmlns:models="using:ProjectSBS.Business.Models"
      xmlns:toolkit="using:CommunityToolkit.WinUI"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:comp="using:ProjectSBS.Presentation.Components"
      xmlns:sys="ProjectSBS:System;assembly=System.Private.CoreLib"
      xmlns:android="http://uno.ui/android"
      mc:Ignorable="d android"
      Background="DarkSlateGray">

    <Page.Resources>
        <Style x:Key="DetailsBorder"
               TargetType="Border">
            <Setter Property="CornerRadius"
                    Value="4" />
            <Setter Property="Background"
                    Value="{ThemeResource CardBackgroundFillColorDefault}" />
            <Setter Property="Padding"
                    Value="16" />
        </Style>

        <Style x:Key="ContentStack"
               TargetType="StackPanel">
            <Setter Property="Padding"
                    Value="8" />
        </Style>
    </Page.Resources>

    <comp:PageShell MobileTitleVisibility="Visible">
        <comp:PageShell.ContentView>

            <UserControl>
                <Grid>
                    <VisualStateManager.VisualStateGroups>
                        <!--AdaptiveTriggers-->
                        <VisualStateGroup>
                            <VisualState>
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="0" />
                                </VisualState.StateTriggers>

                                <VisualState.Setters>
                                    <Setter Target="desktopHeader.Visibility"
                                            Value="Collapsed" />
                                </VisualState.Setters>
                            </VisualState>

                            <VisualState>
                                <VisualState.StateTriggers>
                                    <AdaptiveTrigger MinWindowWidth="640" />
                                </VisualState.StateTriggers>
                            </VisualState>
                        </VisualStateGroup>

                    </VisualStateManager.VisualStateGroups>

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid x:Name="desktopHeader"
                          Visibility="Visible"
                          Padding="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Text="Details"
                                   Style="{StaticResource TitleTextBlockStyle}" />

                        <StackPanel Orientation="Horizontal"
                                    Spacing="8"
                                    Grid.Column="1">
                            <Button Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource FalseToVisibleConverter}}"
                                    Command="{Binding EnableEditingCommand}"
                                    Padding="12, 8">
                                <FontIcon Glyph="&#xE70F;"
                                          FontSize="14" />
                            </Button>

                            <Button Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource FalseToVisibleConverter}}"
                                    Command="{x:Bind ViewModel.DeleteCommand}"
                                    Padding="12, 8">
                                <FontIcon Glyph="&#xE74D;"
                                          FontSize="14" />
                            </Button>

                            <Button Command="{x:Bind ViewModel.CloseCommand}"
                                    Padding="12, 8">
                                <FontIcon Glyph="&#xE8BB;"
                                          FontSize="14" />
                            </Button>
                        </StackPanel>
                    </Grid>

                    <ScrollViewer Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource FalseToVisibleConverter}}"
                                  Grid.Row="1">
                        <StackPanel Spacing="8"
                                    Style="{StaticResource ContentStack}">

                            <Border Style="{StaticResource DetailsBorder}">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="{Binding SelectedItem.Item.Name, Mode=OneWay}"
                                               Style="{StaticResource SubtitleTextBlockStyle}"
                                               TextWrapping="WrapWholeWords" />
                                    <TextBlock TextWrapping="WrapWholeWords">
                                    <Run Text="{Binding SelectedItem.Item.Billing.BasePrice, Mode=OneWay}" />
                                    <Run Text="{Binding SelectedItem.Item.Billing.CurrencyId, Mode=OneWay}" />
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <Border Style="{StaticResource DetailsBorder}">
                                <TextBlock Text="{Binding SelectedItem.Item.Description, Mode=OneWay}"
                                           TextWrapping="WrapWholeWords" />
                            </Border>

                            <Border Style="{StaticResource DetailsBorder}">
                                <ScrollViewer HorizontalScrollMode="Auto"
                                              HorizontalScrollBarVisibility="Auto"
                                              Margin="-16"
                                              Padding="16">
                                    <ItemsRepeater VerticalAlignment="Top"
                                                   ItemsSource="{x:Bind ViewModel.FuturePayments, Mode=OneWay}">
                                        <ItemsRepeater.Layout>
                                            <StackLayout Orientation="Horizontal"
                                                         Spacing="8" />
                                        </ItemsRepeater.Layout>
                                    </ItemsRepeater>
                                </ScrollViewer>
                            </Border>

                        </StackPanel>
                    </ScrollViewer>

                    <Grid Visibility="{x:Bind ViewModel.IsEditing, Mode=TwoWay, Converter={StaticResource TrueToVisibleConverter}}"
                          RowSpacing="12"
                          Grid.Row="1">
                        <Grid.RowDefinitions>
                            <RowDefinition />
                            <RowDefinition Height="45" />
                        </Grid.RowDefinitions>

                        <ScrollViewer>
                            <StackPanel Spacing="16"
                                        Style="{StaticResource ContentStack}">

                                <TextBox Header="Name"
                                         Text="{Binding SelectedItem.Item.Name, Mode=TwoWay}" />

                                <Grid ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <NumberBox Header="Price"
                                               Value="{Binding SelectedItem.Item.Billing.BasePrice, Mode=TwoWay, Converter={StaticResource DecimalToDoubleConverter}}"
                                               SpinButtonPlacementMode="Inline" />
                                    <ComboBox VerticalAlignment="Bottom"
                                              ItemsSource="{x:Bind ViewModel.Currencies, Mode=OneWay}"
                                              SelectedItem="{Binding SelectedItem.Item.Billing.CurrencyId, Mode=TwoWay}"
                                              Grid.Column="1" />
                                </Grid>

                                <!--TODO Make the Tags more safe for future versions, check for inner TagId-->
                                <ComboBox Header="Tag"
                                          ItemsSource="{x:Bind ViewModel.Tags, Mode=OneTime}"
                                          SelectedIndex="{Binding SelectedItem.Item.TagId, Mode=TwoWay}"
                                          VerticalAlignment="Bottom">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:Tag">
                                            <StackPanel Orientation="Horizontal"
                                                        Spacing="12">
                                                <Rectangle Fill="{Binding Color, Converter={StaticResource ColorToBrushConverter}}"
                                                           Width="16"
                                                           Height="16"
                                                           RadiusX="4"
                                                           RadiusY="4" />
                                                <TextBlock Text="{Binding Name}" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <CalendarDatePicker Header="Billing Date"
                                                    Date="{Binding SelectedItem.Item.Billing.InitialDate, Mode=TwoWay, Converter={StaticResource DateOnlyToDateTimeOffsetConverter}}"
                                                    HorizontalAlignment="Stretch" />

                                <Grid ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <NumberBox Header="Repete every"
                                               Value="{Binding SelectedItem.Item.Billing.RecurEvery, Mode=TwoWay}"
                                               SpinButtonPlacementMode="Inline" />
                                    <ComboBox VerticalAlignment="Bottom"
                                              ItemsSource="{toolkit:EnumValues Type=models:Period}"
                                              SelectedItem="{Binding SelectedItem.Item.Billing.PeriodType, Mode=TwoWay}"
                                              Grid.Column="1" />
                                </Grid>
                                
                                <Grid>
                                    <!--TODO Add changing icon here-->
                                    <CheckBox Content="Get notified {NI}"
                                              IsEnabled="True" />
                                    <FontIcon HorizontalAlignment="Right"
                                              Opacity="0.75"
                                              FontSize="18"
                                              Glyph="&#xEA8F;" />
                                </Grid>

                                <Grid>
                                    <CheckBox Content="Split between people {NI}" />
                                    <FontIcon HorizontalAlignment="Right"
                                              Opacity="0.7"
                                              FontSize="18"
                                              Glyph="&#xE748;" />
                                </Grid>
                                <TextBox Header="Description"
                                         Text="{Binding SelectedItem.Item.Description, Mode=TwoWay}"
                                         Height="120"
                                         TextWrapping="Wrap"
                                         AcceptsReturn="True" />
                            </StackPanel>
                        </ScrollViewer>

                        <Button Content="{x:Bind ViewModel.SaveText, Mode=OneWay}"
                                Command="{x:Bind ViewModel.SaveCommand}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                Grid.Row="1" />

                    </Grid>
                </Grid>
            </UserControl>

        </comp:PageShell.ContentView>
    </comp:PageShell>
</Page>
